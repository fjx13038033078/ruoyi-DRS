<!--medication-check.wxml-->
<navigation-bar title="ç”¨è¯æ‰“å¡" back="{{true}}" color="white" background="#667eea"></navigation-bar>

<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">æ­£åœ¨åŠ è½½æ•°æ®...</text>
    </view>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <view class="error-container" wx:if="{{!loading && error}}">
      <view class="error-icon">âš ï¸</view>
      <text class="error-title">åŠ è½½å¤±è´¥</text>
      <text class="error-desc">{{error}}</text>
      <button class="retry-btn" bindtap="retryLoad">é‡æ–°åŠ è½½</button>
    </view>

    <!-- ä¸»è¦å†…å®¹ -->
    <view wx:if="{{!loading && !error}}">
      <!-- ä»Šæ—¥çŠ¶æ€ -->
      <view class="today-status">
        <view class="status-header">
          <text class="status-title">ç”¨è¯æ‰“å¡</text>
          <text class="status-date">{{todayDate}}</text>
        </view>
        <view class="status-desc">
          <text class="desc-text">è®°å½•æ‚¨çš„ç”¨è¯æƒ…å†µï¼Œå¸®åŠ©åŒ»ç”Ÿæ›´å¥½åœ°äº†è§£æ²»ç–—æ•ˆæœ</text>
        </view>
      </view>

      <!-- ç”¨è¯è®°å½•å’Œæ‰“å¡è®°å½•ï¼ˆåˆ†ç»„æ˜¾ç¤ºï¼‰ -->
      <view class="medication-records">
        <view class="section-header">
          <text class="section-title">æˆ‘çš„ç”¨è¯è®°å½•</text>
          <text class="section-subtitle">å…±{{medicationRecords.length}}æ¡è®°å½•</text>
        </view>
        
        <!-- æœ‰ç”¨è¯è®°å½•æ—¶ -->
        <view class="record-list" wx:if="{{medicationRecords.length > 0}}">
          <view class="record-group" wx:for="{{medicationRecords}}" wx:key="id" wx:for-item="record">
            <!-- ç”¨è¯è®°å½•å¡ç‰‡ -->
            <view class="record-item">
              <view class="record-header">
                <view class="drug-icon">ğŸ’Š</view>
                <view class="record-main-info">
                  <text class="drug-name">{{record.drugName || 'æœªçŸ¥è¯å“'}}</text>
                  <view class="drug-meta">
                    <text class="meta-tag">{{record.dosage}}</text>
                    <text class="meta-divider">Â·</text>
                    <text class="meta-tag">{{record.frequency}}</text>
                  </view>
                </view>
              </view>
              
              <view class="drug-dates">
                <view class="date-item">
                  <text class="date-label">å¼€å§‹</text>
                  <text class="date-value">{{record.startDate}}</text>
                </view>
                <view class="date-item" wx:if="{{record.endDate}}">
                  <text class="date-label">ç»“æŸ</text>
                  <text class="date-value">{{record.endDate}}</text>
                </view>
              </view>
              
              <button class="checkin-btn" bindtap="showAddLogForm" data-record="{{record}}">
                <text class="btn-icon">âœ“</text>
                <text class="btn-text">ç«‹å³æ‰“å¡</text>
              </button>
            </view>

            <!-- è¯¥ç”¨è¯è®°å½•çš„æ‰“å¡å†å² -->
            <view class="record-logs" wx:if="{{record.logs && record.logs.length > 0}}">
              <view class="logs-header">
                <text class="logs-title">ğŸ“‹ æ‰“å¡å†å²ï¼ˆ{{record.logs.length}}æ¡ï¼‰</text>
                <view class="logs-toggle" bindtap="toggleLogs" data-record-id="{{record.id}}">
                  {{record.showLogs ? 'æ”¶èµ·' : 'å±•å¼€'}}
                </view>
              </view>
              
              <view class="log-list" wx:if="{{record.showLogs}}">
                <view class="log-item" wx:for="{{record.logs}}" wx:key="id" wx:for-item="log" bindtap="viewLogDetail" data-log="{{log}}">
                  <view class="log-status" style="background-color: {{log.isTaken === 1 ? '#52c41a' : '#ff4d4f'}}">
                    <text class="status-icon">{{log.isTaken === 1 ? 'âœ“' : 'âœ—'}}</text>
                  </view>
                  <view class="log-info">
                    <text class="log-time">{{log.takeTime}}</text>
                    <text class="log-status-text" style="color: {{log.isTaken === 1 ? '#52c41a' : '#ff4d4f'}}">
                      {{log.isTaken === 1 ? 'å·²æœè¯' : 'æœªæœè¯'}}
                    </text>
                  </view>
                  <view class="log-arrow">
                    <text class="arrow-icon">â€º</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:if="{{medicationRecords.length === 0}}">
          <view class="empty-icon">ğŸ’Š</view>
          <text class="empty-title">æš‚æ— ç”¨è¯è®°å½•</text>
          <text class="empty-desc">è¯·è”ç³»åŒ»ç”Ÿæ·»åŠ ç”¨è¯è®¡åˆ’</text>
        </view>
      </view>
    </view>
  </view>
</scroll-view>

<!-- æ·»åŠ æ‰“å¡è¡¨å•å¼¹çª— -->
<view class="form-modal" wx:if="{{showAddLogForm}}">
  <view class="modal-mask" bindtap="hideAddLogForm"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">ç”¨è¯æ‰“å¡</text>
      <text class="modal-close" bindtap="hideAddLogForm">Ã—</text>
    </view>
    
    <view class="form-content">
      <!-- è¯å“ä¿¡æ¯ -->
      <view class="form-item">
        <text class="form-label">è¯å“åç§°</text>
        <view class="form-display">
          <text class="display-text">{{formData.drugName}}</text>
        </view>
      </view>

      <!-- æœè¯çŠ¶æ€ -->
      <view class="form-item">
        <text class="form-label">æœè¯çŠ¶æ€ *</text>
        <view class="form-input" bindtap="selectTakenStatus">
          <text class="input-text">{{formData.isTaken === 1 ? 'å·²æœè¯' : 'æœªæœè¯'}}</text>
          <text class="input-arrow">â€º</text>
        </view>
      </view>

      <!-- æœè¯æ—¶é—´ -->
      <view class="form-item">
        <text class="form-label">æœè¯æ—¶é—´ *</text>
        <view class="form-input" bindtap="selectTakeTime">
          <text class="input-text" wx:if="{{formData.takeTime}}">{{formData.takeTime}}</text>
          <text class="input-placeholder" wx:else>è¯·é€‰æ‹©æœè¯æ—¶é—´</text>
          <text class="input-arrow">â€º</text>
        </view>
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn-cancel" bindtap="hideAddLogForm">å–æ¶ˆ</button>
      <button class="btn-submit" bindtap="submitLog">æäº¤</button>
    </view>
  </view>
</view>

<!-- è®¤è¯å¤±è´¥æç¤º -->
<auth-tip show="{{showAuthTip}}" bind:relogin="handleReLogin"></auth-tip>
