<!--medication-check.wxml-->
<navigation-bar title="ç”¨è¯æ‰“å¡" back="{{true}}" color="white" background="#667eea"></navigation-bar>

<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">æ­£åœ¨åŠ è½½æ•°æ®...</text>
    </view>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <view class="error-container" wx:if="{{!loading && error}}">
      <view class="error-icon">âš ï¸</view>
      <text class="error-title">åŠ è½½å¤±è´¥</text>
      <text class="error-desc">{{error}}</text>
      <button class="retry-btn" bindtap="loadData">é‡æ–°åŠ è½½</button>
    </view>

    <!-- ä¸»è¦å†…å®¹ -->
    <view wx:if="{{!loading && !error}}">
      <!-- ä»Šæ—¥çŠ¶æ€ -->
      <view class="today-status">
        <view class="status-header">
          <text class="status-title">ç”¨è¯æ‰“å¡</text>
          <text class="status-date">{{todayDate}}</text>
        </view>
        <view class="status-desc">
          <text class="desc-text">è®°å½•æ‚¨çš„ç”¨è¯æƒ…å†µï¼Œå¸®åŠ©åŒ»ç”Ÿæ›´å¥½åœ°äº†è§£æ²»ç–—æ•ˆæœ</text>
        </view>
      </view>

      <!-- ç”¨è¯è®°å½• -->
      <view class="medication-records">
        <view class="section-header">
          <text class="section-title">æˆ‘çš„ç”¨è¯è®°å½•</text>
          <text class="section-subtitle">å…±{{medicationRecords.length}}æ¡è®°å½•</text>
        </view>
        
        <view class="record-list" wx:if="{{medicationRecords.length > 0}}">
          <view class="record-item" wx:for="{{medicationRecords}}" wx:key="id">
            <view class="record-info">
              <text class="drug-name">{{item.drugName || 'æœªçŸ¥è¯å“'}}</text>
              <text class="drug-dosage">å‰‚é‡ï¼š{{item.dosage}}</text>
              <text class="drug-frequency">é¢‘ç‡ï¼š{{item.frequency}}</text>
              <view class="drug-dates">
                <text class="start-date">å¼€å§‹ï¼š{{item.startDate}}</text>
                <text class="end-date" wx:if="{{item.endDate}}">ç»“æŸï¼š{{item.endDate}}</text>
              </view>
            </view>
            <view class="record-actions">
              <button class="checkin-btn" bindtap="showAddLogForm" data-record="{{item}}">
                <text class="btn-text">æ‰“å¡</text>
              </button>
            </view>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:if="{{medicationRecords.length === 0}}">
          <view class="empty-icon">ğŸ’Š</view>
          <text class="empty-title">æš‚æ— ç”¨è¯è®°å½•</text>
          <text class="empty-desc">è¯·è”ç³»åŒ»ç”Ÿæ·»åŠ ç”¨è¯è®¡åˆ’</text>
        </view>
      </view>

      <!-- æ‰“å¡è®°å½• -->
      <view class="checkin-logs">
        <view class="section-header">
          <text class="section-title">æ‰“å¡è®°å½•</text>
          <text class="section-subtitle">å…±{{medicationLogs.length}}æ¡è®°å½•</text>
        </view>
        
        <view class="log-list" wx:if="{{medicationLogs.length > 0}}">
          <view class="log-item" wx:for="{{medicationLogs}}" wx:key="id" bindtap="viewLogDetail" data-log="{{item}}">
            <view class="log-status" style="background-color: {{item.isTaken === 1 ? '#52c41a' : '#ff4d4f'}}">
              <text class="status-icon">{{item.isTaken === 1 ? 'âœ“' : 'âœ—'}}</text>
            </view>
            <view class="log-info">
              <text class="log-record">è®°å½•IDï¼š{{item.recordId}}</text>
              <text class="log-time">æ—¶é—´ï¼š{{item.takeTime}}</text>
              <text class="log-status-text" style="color: {{item.isTaken === 1 ? '#52c41a' : '#ff4d4f'}}">
                {{item.isTaken === 1 ? 'å·²æœè¯' : 'æœªæœè¯'}}
              </text>
            </view>
            <view class="log-arrow">
              <text class="arrow-icon">â€º</text>
            </view>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:if="{{medicationLogs.length === 0}}">
          <view class="empty-icon">ğŸ“‹</view>
          <text class="empty-title">æš‚æ— æ‰“å¡è®°å½•</text>
          <text class="empty-desc">å¼€å§‹è®°å½•æ‚¨çš„ç”¨è¯æƒ…å†µ</text>
        </view>
      </view>
    </view>
  </view>
</scroll-view>

<!-- æ·»åŠ æ‰“å¡è¡¨å•å¼¹çª— -->
<view class="form-modal" wx:if="{{showAddLogForm}}">
  <view class="modal-mask" bindtap="hideAddLogForm"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">ç”¨è¯æ‰“å¡</text>
      <text class="modal-close" bindtap="hideAddLogForm">Ã—</text>
    </view>
    
    <view class="form-content">
      <!-- è¯å“ä¿¡æ¯ -->
      <view class="form-item">
        <text class="form-label">è¯å“åç§°</text>
        <view class="form-display">
          <text class="display-text">{{formData.drugName}}</text>
        </view>
      </view>

      <!-- æœè¯çŠ¶æ€ -->
      <view class="form-item">
        <text class="form-label">æœè¯çŠ¶æ€ *</text>
        <view class="form-input" bindtap="selectTakenStatus">
          <text class="input-text">{{formData.isTaken === 1 ? 'å·²æœè¯' : 'æœªæœè¯'}}</text>
          <text class="input-arrow">â€º</text>
        </view>
      </view>

      <!-- æœè¯æ—¶é—´ -->
      <view class="form-item">
        <text class="form-label">æœè¯æ—¶é—´ *</text>
        <view class="form-input" bindtap="selectTakeTime">
          <text class="input-text" wx:if="{{formData.takeTime}}">{{formData.takeTime}}</text>
          <text class="input-placeholder" wx:else>è¯·é€‰æ‹©æœè¯æ—¶é—´</text>
          <text class="input-arrow">â€º</text>
        </view>
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn-cancel" bindtap="hideAddLogForm">å–æ¶ˆ</button>
      <button class="btn-submit" bindtap="submitLog">æäº¤</button>
    </view>
  </view>
</view>
