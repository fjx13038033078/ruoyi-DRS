<!--adverse-reaction.wxml-->
<navigation-bar title="不良反应" back="{{true}}" color="white" background="#667eea"></navigation-bar>

<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    
    <!-- 加载状态 -->
    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">正在加载数据...</text>
    </view>

    <!-- 错误状态 -->
    <view class="error-container" wx:if="{{!loading && error}}">
      <view class="error-icon">⚠️</view>
      <text class="error-title">加载失败</text>
      <text class="error-desc">{{error}}</text>
      <button class="retry-btn" bindtap="retryLoad">重新加载</button>
    </view>

    <!-- 主要内容 -->
    <view wx:if="{{!loading && !error}}">
      <!-- 快速上报按钮 -->
      <view class="quick-report">
        <view class="report-header">
          <text class="report-title">不良反应上报</text>
          <text class="report-subtitle">发现不良反应请及时上报</text>
        </view>
        <button class="report-btn" bindtap="showAddForm">
          <text class="btn-icon">⚠️</text>
          <text class="btn-text">立即上报</text>
        </button>
      </view>

      <!-- 我的上报记录 -->
      <view class="my-reports">
        <view class="section-header">
          <text class="section-title">我的上报记录</text>
          <text class="section-subtitle">共{{reportList.length}}条记录</text>
        </view>
        
        <view class="report-list" wx:if="{{reportList.length > 0}}">
          <view class="report-item" wx:for="{{reportList}}" wx:key="id" bindtap="viewReportDetail" data-report="{{item}}">
            <view class="report-status" style="background-color: {{item.statusColor}}">
              <text class="status-icon">{{item.statusIcon}}</text>
            </view>
            <view class="report-info">
              <text class="report-drug">{{item.drugName || '未知药品'}}</text>
              <text class="report-description">{{item.description}}</text>
              <view class="report-meta">
                <text class="report-severity" style="color: {{item.severity === '轻微' ? '#52c41a' : item.severity === '中度' ? '#faad14' : '#ff4d4f'}}">{{item.severity}}</text>
                <text class="report-time">{{item.occurTime}}</text>
              </view>
            </view>
            <view class="report-arrow">
              <text class="arrow-icon">›</text>
            </view>
          </view>
        </view>

        <!-- 空状态 -->
        <view class="empty-state" wx:if="{{reportList.length === 0}}">
          <view class="empty-icon">📋</view>
          <text class="empty-title">暂无上报记录</text>
          <text class="empty-desc">如有不良反应请及时上报</text>
        </view>
      </view>

      <!-- 温馨提示 -->
      <view class="tips-section">
        <view class="tips-header">
          <text class="tips-icon">💡</text>
          <text class="tips-title">温馨提示</text>
        </view>
        <view class="tips-content">
          <text class="tip-item">• 如出现严重不良反应，请立即就医</text>
          <text class="tip-item">• 保留药品包装和说明书</text>
          <text class="tip-item">• 详细记录症状出现时间和持续时间</text>
          <text class="tip-item">• 及时联系您的主治医师</text>
        </view>
      </view>
    </view>
  </view>
</scroll-view>

<!-- 添加不良反应表单弹窗 -->
<view class="form-modal" wx:if="{{showAddForm}}">
  <view class="modal-mask" bindtap="hideAddForm"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">不良反应上报</text>
      <text class="modal-close" bindtap="hideAddForm">×</text>
    </view>
    
    <view class="form-content">
      <!-- 选择药品 -->
      <view class="form-item">
        <text class="form-label">选择药品 *</text>
        <view class="form-input" bindtap="selectDrug">
          <text class="input-text" wx:if="{{formData.drugName}}">{{formData.drugName}}</text>
          <text class="input-placeholder" wx:else>请选择药品</text>
          <text class="input-arrow">›</text>
        </view>
      </view>

      <!-- 反应描述 -->
      <view class="form-item">
        <text class="form-label">反应描述 *</text>
        <textarea class="form-textarea" 
                  placeholder="请详细描述不良反应的症状、程度等" 
                  value="{{formData.description}}"
                  bindinput="onDescriptionInput"
                  maxlength="500"></textarea>
      </view>

      <!-- 严重程度 -->
      <view class="form-item">
        <text class="form-label">严重程度 *</text>
        <view class="form-input" bindtap="selectSeverity">
          <text class="input-text">{{formData.severity}}</text>
          <text class="input-arrow">›</text>
        </view>
      </view>

      <!-- 发生时间 -->
      <view class="form-item">
        <text class="form-label">发生时间 *</text>
        <view class="form-input" bindtap="selectOccurTime">
          <text class="input-text" wx:if="{{formData.occurTime}}">{{formData.occurTime}}</text>
          <text class="input-placeholder" wx:else>请选择发生时间</text>
          <text class="input-arrow">›</text>
        </view>
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn-cancel" bindtap="hideAddForm">取消</button>
      <button class="btn-submit" bindtap="submitReport">提交</button>
    </view>
  </view>
</view>

<!-- 认证失败提示 -->
<auth-tip show="{{showAuthTip}}" bind:relogin="handleReLogin"></auth-tip>
