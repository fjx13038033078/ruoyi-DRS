<!--medical-record.wxml-->
<navigation-bar title="我的病历" back="{{true}}" color="white" background="#667eea"></navigation-bar>

<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <!-- 加载状态 -->
    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">正在加载病历信息...</text>
    </view>

    <!-- 认证失败提示 -->
    <view class="auth-failure-tip" wx:if="{{showAuthTip}}">
      <view class="tip-content">
        <text class="tip-icon">🔐</text>
        <text class="tip-title">认证失败</text>
        <text class="tip-desc">您的登录可能已过期，请重新登录</text>
        <button class="tip-btn" bindtap="handleReLogin">立即重新登录</button>
      </view>
    </view>


    <!-- 病历信息 -->
    <view class="medical-record" wx:if="{{!loading && patientInfo}}">
      <!-- 基本信息 -->
      <view class="basic-info">
        <view class="patient-name">{{patientInfo.patientName || '未设置'}}</view>
        <view class="patient-details">
          <text class="detail-item">病历号：{{patientInfo.medicalRecordNo || '未设置'}}</text>
          <text class="detail-item">{{patientInfo.age ? patientInfo.age + '岁' : '未设置'}} · {{patientInfo.gender === 'M' ? '男' : patientInfo.gender === 'F' ? '女' : '未设置'}}</text>
          <text class="detail-item" wx:if="{{patientInfo.doctorName}}">医生：{{patientInfo.doctorName}}</text>
        </view>
      </view>

      <!-- 过敏史/病史 -->
      <view class="history-section">
        <view class="section-title">过敏史/病史</view>
        <view class="history-content">
          <text class="history-text">{{patientInfo.history || '暂无记录'}}</text>
        </view>
      </view>
    </view>

    <!-- 空状态提示 -->
    <view class="empty-state" wx:if="{{!loading && !patientInfo}}">
      <view class="empty-icon">📄</view>
      <text class="empty-title">暂无病历信息</text>
      <text class="empty-desc">请联系您的主治医师完善病历信息</text>
    </view>

    <!-- 错误状态 -->
    <view class="error-container" wx:if="{{!loading && error}}">
      <view class="error-icon">⚠️</view>
      <text class="error-title">加载失败</text>
      <text class="error-desc">{{error}}</text>
      <view class="error-actions">
        <button class="retry-btn" bindtap="loadPatientInfo">重新加载</button>
        <button class="logout-btn" bindtap="handleLogout">退出登录</button>
      </view>
      <view class="error-tips" wx:if="{{error.includes('认证失败')}}">
        <text class="tip-text">💡 提示：认证失败通常是因为登录已过期，请退出重新登录</text>
      </view>
    </view>

    <!-- 底部提示 -->
    <view class="bottom-tips">
      <text class="tips-text">如有疑问，请联系您的主治医师</text>
    </view>
  </view>
</scroll-view>
