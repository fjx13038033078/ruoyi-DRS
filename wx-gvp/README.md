# 不良反应信息收集系统 - 小程序端

这是不良反应信息收集系统的微信小程序端，专为患者用户设计。

## 功能特性

### ✅ 已完成功能
- 🔐 **用户登录** - 患者使用用户名和密码登录
- 👤 **用户状态管理** - 全局登录状态管理和持久化
- 🔒 **权限控制** - 确保只有患者角色可以登录小程序
- 📱 **响应式界面** - 美观的现代化UI设计
- 🔄 **自动登录检查** - 启动时自动检查登录状态
- 🚪 **安全退出** - 清理本地存储的用户数据

### 🚧 待开发功能
- 💊 **用药记录管理**
- ⚠️ **不良反应上报**
- 📋 **历史记录查看**
- 👤 **个人信息管理**

## 文件结构

```
wx-gvp/
├── api/                    # API接口
│   └── auth.js            # 认证相关接口
├── utils/                 # 工具函数
│   └── request.js         # 网络请求工具
├── pages/                 # 页面文件
│   ├── login/            # 登录页面
│   └── index/            # 主页
├── components/           # 自定义组件
│   └── navigation-bar/   # 导航栏组件
├── assets/              # 静态资源
└── app.*                # 小程序配置文件
```

## 技术要点

### 网络请求
- 基于微信小程序的 `wx.request` 封装
- 自动处理 token 验证
- 统一错误处理和用户提示
- 401状态码自动跳转登录页

### 状态管理
- 全局 App 实例管理用户状态
- 本地存储 token 和用户信息
- 页面间状态同步

### 安全性
- token 自动过期处理
- 角色权限验证
- 敏感数据清理

## 使用说明

### 环境要求
- 微信开发者工具
- 后端服务运行在 `http://localhost:8080`

### 配置步骤

1. **解决域名校验问题（开发环境）**
   
   **方法1：在微信开发者工具中设置（推荐）**
   - 打开微信开发者工具
   - 点击右上角的"详情"按钮
   - 在"本地设置"选项卡中
   - 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
   
   **方法2：配置生产环境域名**
   - 登录微信公众平台 (mp.weixin.qq.com)
   - 进入"开发" -> "开发管理" -> "开发设置"
   - 在"服务器域名"中添加您的后端域名（必须是HTTPS）
   - 在 `utils/request.js` 中修改生产环境地址

2. **环境配置**
   在 `utils/request.js` 中的 `ENV_CONFIG` 对象中配置不同环境的后端地址：
   ```javascript
   const ENV_CONFIG = {
     development: 'http://localhost:8080',           // 开发环境
     production: 'https://your-domain.com',          // 生产环境
     test: 'https://test-api.your-domain.com'        // 测试环境
   }
   ```

3. **添加logo图片**
   在 `assets/` 目录下添加 `logo.png` 文件（建议尺寸 200x200px）

4. **导入小程序**
   - 打开微信开发者工具
   - 选择导入项目
   - 选择 `wx-gvp` 文件夹

### 登录流程

1. 小程序启动时检查登录状态
2. 未登录用户自动跳转到登录页面
3. 输入用户名和密码（如需要验证码会自动显示）
4. 验证用户角色，确保是患者账号
5. 登录成功后保存用户信息和token
6. 跳转到主页，显示用户信息和功能菜单

### API接口对接

小程序使用与网页端相同的登录接口：

- **登录接口**: `POST /login`
- **获取用户信息**: `GET /getInfo`  
- **退出登录**: `POST /logout`
- **获取验证码**: `GET /captchaImage`

## 开发注意事项

1. **用户角色检查**
   - 登录时会检查用户角色
   - 只允许患者角色(`patient`或`common`)登录小程序
   - 其他角色会被提示使用网页端

2. **token管理**
   - token存储在本地storage中
   - 每次请求自动携带token
   - token过期时自动清理并跳转登录页

3. **错误处理**
   - 网络错误统一提示
   - 业务错误显示具体信息
   - 验证码错误时自动刷新

## 后续开发计划

按优先级排序的功能开发计划：

1. **用药记录管理** - 记录和查看患者用药情况
2. **不良反应上报** - 提交不良反应信息
3. **个人信息管理** - 查看和编辑患者个人信息
4. **历史记录查看** - 查看历史用药和不良反应记录
5. **消息推送** - 接收医生的通知和提醒

## 常见问题解答

### Q: 登录时提示"不在以下 request 合法域名列表中"

**A: 这是微信小程序的安全限制，有两种解决方法：**

**开发环境解决方案（推荐）：**
1. 打开微信开发者工具
2. 点击右上角"详情"
3. 在"本地设置"中勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

**生产环境解决方案：**
1. 确保后端服务使用HTTPS协议
2. 在微信公众平台配置合法域名
3. 修改 `utils/request.js` 中的生产环境地址

### Q: 登录时提示"登录失败"

**A: 可能的原因：**
1. 网络连接问题 - 检查网络是否正常
2. 后端服务未启动 - 确保后端服务运行在正确端口
3. 用户名密码错误 - 检查输入的凭据
4. 用户角色不匹配 - 确保使用的是患者账号

### Q: 如何查看详细的错误信息？

**A: 在微信开发者工具中：**
1. 打开"调试器"面板
2. 查看"Console"选项卡中的错误日志
3. 查看"Network"选项卡中的网络请求详情

### Q: 如何切换到正式环境？

**A: 按以下步骤操作：**
1. 在 `utils/request.js` 中配置生产环境域名
2. 在微信公众平台配置服务器域名
3. 上传代码并发布小程序版本

## 联系方式

如有问题，请联系开发团队或您的主治医师。
