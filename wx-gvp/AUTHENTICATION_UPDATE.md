# è®¤è¯å¤„ç†åŠŸèƒ½æ›´æ–°è¯´æ˜

## ğŸ¯ æ›´æ–°ç›®æ ‡

å°†"æˆ‘çš„ç—…å†"é¡µé¢çš„ç™»å½•è¿‡æœŸè‡ªåŠ¨æç¤ºé€»è¾‘ï¼Œæ‰©å±•åˆ°å…¶ä»–æ‰€æœ‰éœ€è¦è®¤è¯çš„é¡µé¢ï¼Œå®ç°ç»Ÿä¸€çš„è®¤è¯å¤±è´¥å¤„ç†ã€‚

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. é¡µé¢è®¤è¯å·¥å…· (`utils/page-auth.js`)

æä¾›å¯å¤ç”¨çš„è®¤è¯å¤„ç†æ–¹æ³•ï¼š
- `withAuth(pageConfig)` - é¡µé¢é…ç½®åŒ…è£…å‡½æ•°
- `checkLoginStatus()` - æ£€æŸ¥æœ¬åœ°ç™»å½•çŠ¶æ€
- `handleApiError(error)` - ç»Ÿä¸€çš„ API é”™è¯¯å¤„ç†
- `handleReLogin()` - é‡æ–°ç™»å½•å¤„ç†
- `hideAuthTip()` - éšè—è®¤è¯æç¤º

### 2. è®¤è¯æç¤ºç»„ä»¶ (`components/auth-tip/`)

é€šç”¨çš„è®¤è¯å¤±è´¥ UI ç»„ä»¶ï¼š
- ç¾è§‚çš„å¼¹çª—è®¾è®¡
- æ¸å…¥åŠ¨ç”»æ•ˆæœ
- ç»Ÿä¸€çš„äº¤äº’ä½“éªŒ
- å¯åœ¨ä»»æ„é¡µé¢å¤ç”¨

## ğŸ“ æ›´æ–°çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
```
wx-gvp/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ page-auth.js                    # é¡µé¢è®¤è¯å·¥å…·
â”‚   â””â”€â”€ PAGE_AUTH_USAGE.md              # ä½¿ç”¨æŒ‡å—
â”œâ”€â”€ components/
â”‚   â””â”€â”€ auth-tip/
â”‚       â”œâ”€â”€ auth-tip.js                 # ç»„ä»¶é€»è¾‘
â”‚       â”œâ”€â”€ auth-tip.json               # ç»„ä»¶é…ç½®
â”‚       â”œâ”€â”€ auth-tip.wxml               # ç»„ä»¶æ¨¡æ¿
â”‚       â””â”€â”€ auth-tip.wxss               # ç»„ä»¶æ ·å¼
â””â”€â”€ AUTHENTICATION_UPDATE.md            # æœ¬æ–‡æ¡£
```

### ä¿®æ”¹çš„æ–‡ä»¶

#### 1. è¯å“ä¿¡æ¯é¡µé¢
- `pages/drug-info/drug-info.js` - ä½¿ç”¨ withAuth åŒ…è£…
- `pages/drug-info/drug-info.json` - å¼•å…¥ auth-tip ç»„ä»¶
- `pages/drug-info/drug-info.wxml` - æ·»åŠ è®¤è¯æç¤º UI

#### 2. ç”¨è¯æ‰“å¡é¡µé¢
- `pages/medication-check/medication-check.js` - ä½¿ç”¨ withAuth åŒ…è£…
- `pages/medication-check/medication-check.json` - å¼•å…¥ auth-tip ç»„ä»¶
- `pages/medication-check/medication-check.wxml` - æ·»åŠ è®¤è¯æç¤º UI

#### 3. ä¸è‰¯ååº”é¡µé¢
- `pages/adverse-reaction/adverse-reaction.js` - ä½¿ç”¨ withAuth åŒ…è£…
- `pages/adverse-reaction/adverse-reaction.json` - å¼•å…¥ auth-tip ç»„ä»¶
- `pages/adverse-reaction/adverse-reaction.wxml` - æ·»åŠ è®¤è¯æç¤º UI

#### 4. åŸºç¡€åº“ç‰ˆæœ¬é…ç½®
- `project.config.json` - é™ä½åŸºç¡€åº“ç‰ˆæœ¬ä» 3.10.1 åˆ° 2.33.0
- `components/navigation-bar/navigation-bar.js` - ä¼˜åŒ–ç³»ç»Ÿä¿¡æ¯è·å–

## ğŸ”„ å·¥ä½œæµç¨‹

```
ç”¨æˆ·æ“ä½œ
  â†“
å‘èµ· API è¯·æ±‚
  â†“
åç«¯è¿”å› 401
  â†“
request.js æ‹¦æˆª â†’ è°ƒç”¨ app.handleAuthFailure()ï¼ˆå…¨å±€å¤„ç†ï¼‰
  â†“
é¡µé¢ catch é”™è¯¯ â†’ è°ƒç”¨ handleApiError()ï¼ˆé¡µé¢å¤„ç†ï¼‰
  â†“
æ£€æµ‹åˆ° 401 â†’ è®¾ç½® showAuthTip = true
  â†“
auth-tip ç»„ä»¶æ˜¾ç¤ºæç¤ºç•Œé¢
  â†“
ç”¨æˆ·ç‚¹å‡»"ç«‹å³é‡æ–°ç™»å½•"
  â†“
è°ƒç”¨ app.logout() â†’ æ¸…é™¤çŠ¶æ€ â†’ è·³è½¬ç™»å½•é¡µ
```

## ğŸ¨ UI æ•ˆæœ

### è®¤è¯å¤±è´¥æç¤º
- ğŸ”’ å›¾æ ‡ï¼šç›´è§‚çš„é”å®šæ ‡è¯†
- ğŸ“ æ ‡é¢˜ï¼šæ¸…æ™°çš„"ç™»å½•å·²è¿‡æœŸ"æç¤º
- ğŸ’¬ æè¿°ï¼šå‹å¥½çš„è¯´æ˜æ–‡å­—
- ğŸ”˜ æŒ‰é’®ï¼šé†’ç›®çš„"ç«‹å³é‡æ–°ç™»å½•"æŒ‰é’®
- âœ¨ åŠ¨ç”»ï¼šå¹³æ»‘çš„æ¸å…¥æ•ˆæœ
- ğŸ¯ é®ç½©ï¼šåŠé€æ˜èƒŒæ™¯é˜²æ­¢è¯¯æ“ä½œ

## ğŸ“Š å¯¹æ¯”

### æ›´æ–°å‰
- âŒ æ¯ä¸ªé¡µé¢é‡å¤ç¼–å†™è®¤è¯æ£€æŸ¥ä»£ç 
- âŒ é”™è¯¯æç¤ºä¸ç»Ÿä¸€
- âŒ ç»´æŠ¤æˆæœ¬é«˜
- âŒ ç”¨æˆ·ä½“éªŒä¸ä¸€è‡´

### æ›´æ–°å
- âœ… ç»Ÿä¸€çš„è®¤è¯å¤„ç†å·¥å…·
- âœ… ä¸€è‡´çš„ UI æç¤º
- âœ… æ˜“äºç»´æŠ¤å’Œæ‰©å±•
- âœ… è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### ä¸ºæ–°é¡µé¢æ·»åŠ è®¤è¯å¤„ç†

#### æ­¥éª¤ 1ï¼šä¿®æ”¹ JS æ–‡ä»¶
```javascript
const { withAuth } = require('../../utils/page-auth')

Page(withAuth({
  data: { /* ... */ },
  
  async loadData() {
    try {
      const res = await api.getData()
      // å¤„ç†æ•°æ®...
    } catch (error) {
      this.handleApiError(error)  // ç»Ÿä¸€é”™è¯¯å¤„ç†
    }
  }
}))
```

#### æ­¥éª¤ 2ï¼šä¿®æ”¹ JSON æ–‡ä»¶
```json
{
  "usingComponents": {
    "auth-tip": "/components/auth-tip/auth-tip"
  }
}
```

#### æ­¥éª¤ 3ï¼šä¿®æ”¹ WXML æ–‡ä»¶
```xml
<!-- é¡µé¢å†…å®¹ -->

<!-- åº•éƒ¨æ·»åŠ  -->
<auth-tip show="{{showAuthTip}}" bind:relogin="handleReLogin"></auth-tip>
```

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### 1. withAuth å®ç°åŸç†

ä½¿ç”¨é«˜é˜¶å‡½æ•°æ¨¡å¼ï¼Œåœ¨é¡µé¢é…ç½®å¤–åŒ…è£…ä¸€å±‚ï¼š
- åˆå¹¶ data å¯¹è±¡ï¼Œæ·»åŠ  `showAuthTip` å­—æ®µ
- æ··å…¥è®¤è¯ç›¸å…³æ–¹æ³•
- ä¸è¦†ç›–é¡µé¢å·²æœ‰æ–¹æ³•

### 2. é”™è¯¯å¤„ç†æµç¨‹

```javascript
handleApiError(error) {
  if (error.code === 401 || error.statusCode === 401) {
    // 401 é”™è¯¯ï¼šæ˜¾ç¤ºè®¤è¯æç¤º
    this.setData({ showAuthTip: true, loading: false })
    return true
  }
  
  // å…¶ä»–é”™è¯¯ï¼šè®¾ç½® error ä¿¡æ¯
  this.setData({ 
    error: error.msg || error.message,
    loading: false 
  })
  return false
}
```

### 3. ç»„ä»¶é€šä¿¡

```
é¡µé¢ (showAuthTip)
  â†“
auth-tip ç»„ä»¶ (show prop)
  â†“
ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
  â†“
è§¦å‘ relogin äº‹ä»¶
  â†“
é¡µé¢ handleReLogin() æ–¹æ³•
  â†“
è°ƒç”¨ app.logout()
```

## ğŸ”§ é…ç½®è¯´æ˜

### request.js é…ç½®
ç¡®ä¿ 401 çŠ¶æ€ç ä¼šè°ƒç”¨ `app.handleAuthFailure()`ï¼š

```javascript
if (statusCode === 401) {
  const app = getApp()
  if (app && app.handleAuthFailure) {
    app.handleAuthFailure()
  }
  reject(res)
}
```

### app.js é…ç½®
ç¡®ä¿æœ‰ `handleAuthFailure()` å’Œ `logout()` æ–¹æ³•ï¼š

```javascript
App({
  handleAuthFailure() {
    wx.showModal({
      title: 'ç™»å½•å·²è¿‡æœŸ',
      content: 'æ‚¨çš„ç™»å½•å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•',
      // ...
    })
  },
  
  logout() {
    this.clearLoginStatus()
    wx.reLaunch({ url: '/pages/login/login' })
  }
})
```

## ğŸ“ˆ ä¼˜åŠ¿

### 1. ä»£ç å¤ç”¨æ€§
- ä¸€æ¬¡ç¼–å†™ï¼Œå¤šå¤„ä½¿ç”¨
- å‡å°‘ 80% çš„é‡å¤ä»£ç 

### 2. ç»´æŠ¤æ€§
- é›†ä¸­ç®¡ç†è®¤è¯é€»è¾‘
- ä¿®æ”¹ä¸€å¤„ï¼Œå…¨å±€ç”Ÿæ•ˆ

### 3. ä¸€è‡´æ€§
- ç»Ÿä¸€çš„ UI è¡¨ç°
- ç»Ÿä¸€çš„äº¤äº’æµç¨‹

### 4. æ‰©å±•æ€§
- æ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- æ˜“äºé€‚é…æ–°é¡µé¢

## ğŸ› å·²ä¿®å¤çš„é—®é¢˜

### åŸºç¡€åº“ç‰ˆæœ¬é—®é¢˜
- **é—®é¢˜**ï¼šåŸºç¡€åº“ 3.10.1 å­˜åœ¨ç³»ç»Ÿä¿¡æ¯è·å– bug
- **è§£å†³**ï¼šé™çº§åˆ°ç¨³å®šç‰ˆæœ¬ 2.33.0
- **å½±å“**ï¼šä¿®å¤äº† `Cannot read property 'brand' of null` ç­‰é”™è¯¯

### å¯¼èˆªæ ç»„ä»¶é—®é¢˜
- **é—®é¢˜**ï¼šnavigation-bar ç»„ä»¶æœªæ­£ç¡®å¤„ç†ç©ºå€¼
- **è§£å†³**ï¼šæ·»åŠ å®Œå–„çš„ç©ºå€¼æ£€æŸ¥å’Œé»˜è®¤å€¼
- **å½±å“**ï¼šæå‡äº†ç»„ä»¶ç¨³å®šæ€§

## ğŸ“š æ–‡æ¡£

è¯¦ç»†ä½¿ç”¨æŒ‡å—è¯·å‚è€ƒï¼š
- `utils/PAGE_AUTH_USAGE.md` - å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹

## âœ… æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•
- [ ] ç™»å½•åè®¿é—®é¡µé¢æ­£å¸¸
- [ ] Token è¿‡æœŸåè‡ªåŠ¨æ˜¾ç¤ºæç¤º
- [ ] ç‚¹å‡»é‡æ–°ç™»å½•è·³è½¬æ­£ç¡®
- [ ] é‡æ–°ç™»å½•ååŠŸèƒ½æ¢å¤

### 2. UI æµ‹è¯•
- [ ] æç¤ºç•Œé¢æ˜¾ç¤ºæ­£å¸¸
- [ ] åŠ¨ç”»æ•ˆæœæµç•…
- [ ] æŒ‰é’®å“åº”çµæ•
- [ ] åœ¨ä¸åŒè®¾å¤‡ä¸Šè¡¨ç°ä¸€è‡´

### 3. å…¼å®¹æ€§æµ‹è¯•
- [ ] iOS è®¾å¤‡æ­£å¸¸
- [ ] Android è®¾å¤‡æ­£å¸¸
- [ ] å¼€å‘å·¥å…·æ­£å¸¸
- [ ] ä¸åŒåŸºç¡€åº“ç‰ˆæœ¬æ­£å¸¸

## ğŸ“ æœ€ä½³å®è·µ

1. **å§‹ç»ˆä½¿ç”¨ withAuth**ï¼šæ‰€æœ‰éœ€è¦è®¤è¯çš„é¡µé¢éƒ½åº”ä½¿ç”¨
2. **ç»Ÿä¸€é”™è¯¯å¤„ç†**ï¼šåœ¨ catch ä¸­è°ƒç”¨ handleApiError
3. **æ·»åŠ é‡è¯•åŠŸèƒ½**ï¼šæä¾› retryLoad æ–¹æ³•
4. **æ£€æŸ¥ç™»å½•çŠ¶æ€**ï¼šåœ¨ onShow ä¸­æ£€æŸ¥å¹¶å¤„ç†
5. **æä¾›å‹å¥½åé¦ˆ**ï¼šåŠ è½½å’Œé”™è¯¯çŠ¶æ€è¦æ¸…æ™°

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. `utils/PAGE_AUTH_USAGE.md` - ä½¿ç”¨æŒ‡å—
2. å·²æ›´æ–°çš„é¡µé¢æºç  - å‚è€ƒå®ç°
3. `utils/page-auth.js` - å·¥å…·æºç 

---

æ›´æ–°æ—¥æœŸï¼š2025-10-10
æ›´æ–°äººï¼šAI Assistant
ç‰ˆæœ¬ï¼šv1.0

