<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.documentary.mapper.DocumentaryMapper">

    <resultMap type="Documentary" id="DocumentaryResult">
        <id property="documentaryId" column="documentary_id"/>
        <result property="documentaryName" column="documentary_name"/>
        <result property="detailUrl" column="detail_url"/>
        <result property="playCount" column="play_count"/>
        <result property="documentaryType" column="documentary_type"/>
        <result property="releaseYear" column="release_year"/>
        <result property="totalEpisodes" column="total_episodes"/>
        <result property="rating" column="rating"/>
        <result property="likeCount" column="like_count"/>
        <result property="director" column="director"/>
        <result property="description" column="description"/>
        <result property="broadcastTime" column="broadcast_time"/>
        <result property="status" column="status"/>
        <result property="coverImageUrl" column="cover_image_url"/>
        <result property="imagePath" column="image_path"/>
    </resultMap>

    <!-- 获取所有纪录片 -->
    <select id="getAllDocumentaries" parameterType="Documentary" resultMap="DocumentaryResult">
        SELECT * FROM drs_documentary
        <where>
            <if test="documentaryName != null and documentaryName != ''">
                AND documentary_name like concat('%', #{documentaryName}, '%')
            </if>
            <if test="documentaryType != null and documentaryType != ''">
                AND documentary_type = #{documentaryType}
            </if>
            <if test="releaseYear != null">
                AND release_year = #{releaseYear}
            </if>
            <if test="broadcastTime != null and broadcastTime != ''">
                AND broadcast_time = #{broadcastTime}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="params.showPendingAndRejected != null and params.showPendingAndRejected == 'yes'">
                AND status IN (1, 3)
            </if>
            <if test="params.minPlayCount != null">
                AND play_count &gt;= #{params.minPlayCount}
            </if>
            <if test="params.maxPlayCount != null">
                AND play_count &lt;= #{params.maxPlayCount}
            </if>
            <if test="params.minLikeCount != null">
                AND like_count &gt;= #{params.minLikeCount}
            </if>
            <if test="params.maxLikeCount != null">
                AND like_count &lt;= #{params.maxLikeCount}
            </if>
        </where>
        ORDER BY documentary_id DESC
    </select>

    <!-- 根据纪录片ID获取纪录片信息 -->
    <select id="getDocumentaryById" parameterType="Long" resultMap="DocumentaryResult">
        SELECT * FROM drs_documentary WHERE documentary_id = #{documentaryId}
    </select>

    <!-- 添加纪录片 -->
    <insert id="addDocumentary" parameterType="Documentary">
        INSERT INTO drs_documentary (documentary_name, detail_url, play_count, documentary_type, release_year, total_episodes, rating, like_count, director, description, broadcast_time, status, cover_image_url, image_path)
        VALUES (#{documentaryName}, #{detailUrl}, #{playCount}, #{documentaryType}, #{releaseYear}, #{totalEpisodes}, #{rating}, #{likeCount}, #{director}, #{description}, #{broadcastTime}, COALESCE(#{status}, 1), #{coverImageUrl}, #{imagePath})
    </insert>

    <!-- 更新纪录片信息 -->
    <update id="updateDocumentary" parameterType="Documentary">
        UPDATE drs_documentary
        SET documentary_name = #{documentaryName}, detail_url = #{detailUrl},
            play_count = #{playCount}, documentary_type = #{documentaryType},
            release_year = #{releaseYear}, total_episodes = #{totalEpisodes},
            rating = #{rating}, like_count = #{likeCount},
            director = #{director}, description = #{description},
            broadcast_time = #{broadcastTime},
            cover_image_url = #{coverImageUrl}, image_path = #{imagePath}
            <if test="status != null">, status = #{status}</if>
        WHERE documentary_id = #{documentaryId}
    </update>

    <!-- 删除纪录片 -->
    <delete id="deleteDocumentary" parameterType="Long">
        DELETE FROM drs_documentary WHERE documentary_id = #{documentaryId}
    </delete>

    <!-- 更新纪录片审核状态 -->
    <update id="updateDocumentaryStatus">
        UPDATE drs_documentary
        SET status = #{status}
        WHERE documentary_id = #{documentaryId}
    </update>

    <!-- 统计各年份纪录片数量 -->
    <select id="getYearStatistics" resultType="com.ruoyi.documentary.domain.dto.YearStatisticsDTO">
        SELECT release_year as year, COUNT(*) as count
        FROM drs_documentary
        WHERE release_year IS NOT NULL AND status = 2
        GROUP BY release_year
        ORDER BY release_year ASC
    </select>

    <!-- 统计各类型纪录片数量 -->
    <select id="getTypeStatistics" resultType="com.ruoyi.documentary.domain.dto.TypeStatisticsDTO">
        SELECT documentary_type as type, COUNT(*) as count
        FROM drs_documentary
        WHERE documentary_type IS NOT NULL AND documentary_type != '' AND status = 2
        GROUP BY documentary_type
        ORDER BY count DESC
    </select>

</mapper>

